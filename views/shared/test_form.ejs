<%- include('./includes/head.ejs') %>

<body class="theme3">
    <%- include('./includes/loader.ejs') %>

    <%- include('./includes/navbar.ejs') %>
    
    <div class="breadcumb-wrapper" data-bg-src="/assets/img/bg/breadcumb-bg.jpg">
        <div class="container">
            <div class="breadcumb-content">
                <h1 class="breadcumb-title" style="text-transform: capitalize;">Начать тест</h1>
                <ul class="breadcumb-menu">
                    <li><a href="/">Главная страница</a></li>
                    <li style="text-transform: capitalize;" >Начать тест</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="bg-smoke space" data-bg-src="/assets/img/bg/contact_bg_1.png" id="start-test-sec">
    <div class="container">
      <div class="row">
        <div class="col-xl-8">
            <div class="title-area mb-35 text-xl-start text-center">
              <span class="sub-title">
                <div class="icon-masking me-2">
                  <span class="mask-icon" data-mask-src="/assets/img/theme-img/title_shape_2.svg"></span>
                  <img src="/assets/img/theme-img/title_shape_2.svg" alt="shape">
                </div>
                Начать тест
              </span>
              <h2 class="sec-title">Введите свои данные</h2>
              <p class="sec-text">
                Пожалуйста, заполните форму ниже, чтобы начать выбранный тест.
              </p>
            </div>

            <form id="startTestForm" class="contact-form" action="" method="post">
              <div class="row">
                <div class="form-group col-md-6">
                  <input type="text" class="form-control" name="first_name" id="first_name" placeholder="Имя" required>
                  <i class="fal fa-user"></i>
                </div>
                <div class="form-group col-md-6">
                  <input type="text" class="form-control" name="last_name" id="last_name" placeholder="Фамилия" required>
                  <i class="fal fa-user"></i>
                </div>
                <div class="form-group col-md-6">
                  <input type="email" class="form-control" name="email" id="email" placeholder="Электронная почта" required>
                  <i class="fal fa-envelope"></i>
                </div>
                <div class="form-group col-md-6">
                  <div class="phone-input">
                    <span class="prefix">+998</span>
                    <input 
                      id="phone_ui"
                      type="text"
                      inputmode="numeric"
                      autocomplete="tel"
                      placeholder="(__) __-__-__"
                      aria-describedby="phone_help"
                      required
                    >
                  </div>
                  <i class="fal fa-phone"></i>
                </div>
                <div class="form-group col-md-6">
                  <input type="text" class="form-control" disabled value="<%= test.test_name %>">
                  <i class="fal fa-comment"></i>
                </div>
                <input type="hidden" name="phone" id="phone_hidden" />
                <div class="form-group col-md-6">
                  <input type="text" class="form-control" hidden value="<%= test.id %>" name="test_id">
                </div>
                <div class="form-btn text-xl-start text-center col-12">
                  <button type="submit" id="startTestBtn" class="th-btn">
                    Начать тест <i class="fa-regular fa-arrow-right ms-2"></i>
                  </button>
                </div>
              </div>
            </form>
        </div>
      </div>
    </div>
  </div>


  <!-- Optional modal for missing input or confirmation -->
  <div class="modal fade" id="missingDataModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <h5 class="modal-title mb-3">Заполните все поля</h5>
        <p>Пожалуйста, убедитесь, что все поля заполнены перед началом теста.</p>
        <button type="button" class="btn btn-primary mt-3" data-bs-dismiss="modal">Понятно</button>
      </div>
    </div>
  </div>

    
    
    <%- include('./includes/footer.ejs') %>
    
    <%- include('./includes/end.ejs') %>

    <script>
      (function () {
        const ui = document.getElementById('phone_ui');
        const hidden = document.getElementById('phone_hidden');
        const form = document.getElementById('phoneForm');
        const error = document.getElementById('phone_error');

        function formatDigits(d) {
          if (!d) return '';
          const a = d.slice(0, 2);
          const b = d.slice(2, 5);
          const c = d.slice(5, 7);
          const e = d.slice(7, 9);
          let out = '';
          if (a) out += '(' + a + ')';
          if (b) out += ' ' + b;
          if (c) out += '-' + c;
          if (e) out += '-' + e;
          return out.trim();
        }

        function setDigits(d) {
          // keep only digits, max 9 now
          let digits = d.replace(/\D/g, '');
          if (digits.length > 9 && digits.startsWith('998')) {
            digits = digits.slice(digits.length - 9);
          } else {
            digits = digits.slice(0, 9);
          }
          ui.value = formatDigits(digits);
          hidden.value = digits;
          error.textContent = '';
        }

        ui.addEventListener('input', function () {
          setDigits(ui.value);
        });

        ui.addEventListener('keydown', function (e) {
          const allowed = [
            'Backspace', 'Tab', 'ArrowLeft', 'ArrowRight',
            'Delete', 'Home', 'End'
          ];
          if (allowed.includes(e.key)) return;
          if (e.ctrlKey || e.metaKey) return;
          if (/^[0-9]$/.test(e.key)) return;
          e.preventDefault();
        });

        ui.addEventListener('paste', function (e) {
          e.preventDefault();
          const pasted = (e.clipboardData || window.clipboardData).getData('text') || '';
          setDigits(pasted);
        });

        form.addEventListener('submit', function (e) {
          const digits = (hidden.value || '').replace(/\D/g, '');
          if (digits.length !== 9) {
            e.preventDefault();
            error.textContent = 'Please enter exactly 9 digits.';
            ui.focus();
            return false;
          }
          hidden.value = digits;
          return true;
        });
      })();
    </script>

</body>

</html>